<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Comande in Corso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
            padding: 0.5rem 0.75rem;
            background: var(--pico-primary);
            color: var(--pico-primary-inverse);
            border: none;
            border-radius: 6px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }

        .home-btn:hover {
            background: var(--pico-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .home-btn svg {
            width: 16px;
            height: 16px;
        }

        .product {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .product img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        article {
            padding: 1rem;
        }

        .stato {
            font-weight: bold;
            font-size: 0.9rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .stato.in_corso {
            background-color: #fef08a;
            /* giallo chiaro */
            color: #92400e;
        }

        .stato.pronta {
            background-color: #bbf7d0;
            /* verde chiaro */
            color: #166534;
        }

        .cestino-btn {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            margin-left: 1rem;
        }

        .cestino-btn:hover {
            background: #b91c1c;
            transform: scale(1.05);
        }

        .cestino-btn svg {
            width: 18px;
            height: 18px;
        }
    </style>
</head>

<body>
    <main class="container">
        <a href="/cameriere" class="home-btn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                </path>
            </svg>
            Home
        </a>
        <h1 align="center">Comande in corso</h1>
        <div id="comandeContainer"></div>
    </main>

    <script>
        async function loadComande() {
            try {
                const res = await fetch('/api/comande');
                const data = await res.json();
              
                // Ordina le comande in ordine decrescente (dalla più recente alla più vecchia)
                data.sort((a, b) => b.id - a.id);
              
                const container = document.getElementById('comandeContainer');
                
                // Svuota il container prima di riempirlo
                container.innerHTML = '';

                data.forEach(comanda => {
                    const prodottiRaggruppati = {};

                    // Raggruppa per nome prodotto
                    comanda.prodotti.forEach(p => {
                        const key = p.nome_prodotto;
                        if (!prodottiRaggruppati[key]) {
                            prodottiRaggruppati[key] = { ...p, quantita: 1 };
                        } else {
                            prodottiRaggruppati[key].quantita += 1;
                        }
                    });

                    // Crea l'articolo
                    const article = document.createElement('article');

                    // Costruisci gli stati solo se diversi da 'n'
                    let statoHtml = '';
                    if (comanda.stato && comanda.stato !== 'n') {
                        statoHtml += `
                            <span class="stato ${comanda.stato}">
                                Cucina: ${comanda.stato === 'pronta' ? 'Pronta' : comanda.stato.replace('_', ' ')}
                            </span>`;
                    }
                    if (comanda.stato_drink && comanda.stato_drink !== 'n') {
                        statoHtml += `
                            <span class="stato ${comanda.stato_drink}">
                                Bar: ${comanda.stato_drink === 'pronta' ? 'Pronta' : comanda.stato_drink.replace('_', ' ')}
                            </span>`;
                    }

                    // Verifica se la comanda è completamente pronta
                    const cucinaOk = !comanda.stato || comanda.stato === 'n' || comanda.stato === 'pronta';
                    const barOk = !comanda.stato_drink || comanda.stato_drink === 'n' || comanda.stato_drink === 'pronta';
                    const comandaPronta = cucinaOk && barOk;

                    // Aggiungi il cestino se la comanda è pronta
                    let cestinoBtnHtml = '';
                    if (comandaPronta) {
                        cestinoBtnHtml = `
                            <button class="cestino-btn" onclick="rimuoviComanda(${comanda.id})">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                                Rimuovi
                            </button>`;
                    }

                    article.innerHTML = `
                        <h2 style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                Comanda #${comanda.id} - Tavolo ${comanda.tavolo}
                                ${statoHtml}
                            </div>
                            ${cestinoBtnHtml}
                        </h2>

                        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                            ${comanda.prodotti.map(prodotto => `
                                <div style="text-align: center;">
                                    <img src="${prodotto.foto}" alt="${prodotto.nome}" style="width: 100px; border-radius: 8px;" />
                                    <p>${prodotto.nome}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    container.appendChild(article);
                });

            } catch (err) {
                console.error('Errore nel caricamento delle comande:', err);
            }
        }

        // Funzione per rimuovere una comanda
        async function rimuoviComanda(comandaId) {
            try {
                const res = await fetch('/api/cameriere/done', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ comanda_id: comandaId })
                });

                if (res.ok) {
                    console.log(`Comanda #${comandaId} rimossa con successo`);
                    // Ricarica immediatamente le comande per aggiornare la vista
                    loadComande();
                } else {
                    console.error('Errore nella rimozione della comanda');
                    alert('Errore nella rimozione della comanda');
                }
            } catch (err) {
                console.error('Errore nella chiamata API:', err);
                alert('Errore di connessione');
            }
        }

        // Carica le comande al primo caricamento
        loadComande();
        
        // Aggiorna le comande ogni 4 secondi
        setInterval(loadComande, 4000);
    </script>
</body>

</html>